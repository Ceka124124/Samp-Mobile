<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>WebRTC √áoklu Koltuk Sesli Sohbet</title>
  <style>
    /* Reset and base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #483D8B, #6A5ACD);
      color: #f0f0ff;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #app {
      max-width: 350px;
      margin: auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px 14px;
      gap: 10px;
    }
    h1 {
      text-align: center;
      margin: 10px 0;
      font-weight: 900;
      font-size: 1.8rem;
      color: #cbd5e1;
      text-shadow: 0 0 4px #94a3b8;
      user-select: none;
    }

    #message-screen {
      flex: 1;
      background: rgba(0,0,0,0.2);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      text-align: center;
      user-select: none;
    }

    #room-screen {
      flex: 1;
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #seats-container {
      flex-grow: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px;
      user-select: none;
    }
    .seat {
      background: rgba(255,255,255,0.15);
      border-radius: 14px;
      height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 12px;
      cursor: pointer;
      position: relative;
      box-shadow: 0 6px 10px rgba(0,0,0,0.25);
      transition: background-color 0.25s, box-shadow 0.3s;
      color: #e0e7ff;
    }
    .seat:hover {
      background: rgba(107, 70, 193, 0.8);
      box-shadow: 0 8px 22px #a78bfa;
    }
    .seat.occupied {
      cursor: default;
      background: #4338ca;
      box-shadow: 0 0 16px 2px #8b5cf6;
    }
    .seat .username {
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      overflow-wrap: break-word;
    }
    .seat .status {
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .seat .mute-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 22px;
      pointer-events: none;
      user-select: none;
      opacity: 0.8;
      color: #f87171; /* red for muted */
      display: none;
    }
    .seat.muted .mute-icon {
      display: block;
    }
    .seat.you {
      border: 3px solid #a78bfa;
    }

    #mute-btn {
      background: #a855f7;
      border: none;
      padding: 14px 0;
      color: white;
      font-weight: 700;
      font-size: 1.2rem;
      border-radius: 14px;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 5px 15px rgba(168,85,247,0.6);
      transition: background-color 0.3s ease;
    }
    #mute-btn.unmuted {
      background: #22c55e;
      box-shadow: 0 5px 15px rgba(34,197,94,0.7);
    }
    #mute-btn:disabled {
      background: #999;
      cursor: not-allowed;
      box-shadow: none;
    }
    #mute-btn:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    #status-bar {
      font-weight: 600;
      font-size: 1rem;
      min-height: 1.4em;
      color: #c5c7f8;
      text-align: center;
      margin-top: 6px;
      user-select: none;
    }

    #seats-container {
      overflow-y: auto;
    }

    #chat-container {
      background: rgba(255 255 255 / 0.1);
      border-radius: 14px;
      padding: 10px;
      height: 150px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      user-select: none;
    }
    #chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      background: rgba(0 0 0 / 0.15);
      border-radius: 12px;
      padding: 8px;
      font-size: 0.9rem;
      color: #e0e7ff;
      scroll-behavior: smooth;
    }
    #chat-input-container {
      display: flex;
      gap: 6px;
    }
    #chat-input {
      flex-grow: 1;
      border-radius: 14px;
      border: none;
      padding: 8px 12px;
      font-size: 1rem;
      outline: none;
    }
    #chat-send-btn {
      background: #6b46c1;
      color: white;
      border: none;
      border-radius: 14px;
      padding: 8px 16px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    #chat-send-btn:hover:not(:disabled) {
      background: #553c9a;
    }
    #chat-send-btn:disabled {
      background: #999;
      cursor: not-allowed;
    }

    #gift-container {
      display: flex;
      justify-content: center;
      margin-top: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .gift-box {
      background: rgba(255 255 255 / 0.15);
      border-radius: 12px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      user-select: none;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .gift-box:hover {
      background: rgba(107, 70, 193, 0.9);
      box-shadow: 0 6px 16px rgba(107,70,193,0.8);
    }

    @media (max-width: 400px) {
      #app {
        max-width: 100%;
        padding: 8px 10px;
      }
      .seat {
        height: 100px;
      }
      h1 {
        font-size: 1.5rem;
      }
      #mute-btn {
        font-size: 1rem;
        padding: 12px 0;
      }
      #chat-container {
        height: 130px;
      }
      .gift-box {
        width: 36px;
        height: 36px;
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>WebRTC Koltuk Sesli Sohbet</h1>

    <div id="message-screen" style="display:none;"></div>

    <div id="room-screen">
      <div>Oda: <span id="room-name-display"></span> | Kullanƒ±cƒ±: <span id="username-display"></span></div>
      <div id="seats-container">
        <div class="seat" data-seat="1"><div class="username"></div><div class="status"></div><div class="mute-icon">üîá</div></div>
        <div class="seat" data-seat="2"><div class="username"></div><div class="status"></div><div class="mute-icon">üîá</div></div>
        <div class="seat" data-seat="3"><div class="username"></div><div class="status"></div><div class="mute-icon">üîá</div></div>
        <div class="seat" data-seat="4"><div class="username"></div><div class="status"></div><div class="mute-icon">üîá</div></div>
        <div class="seat" data-seat="5"><div class="username"></div><div class="status"></div><div class="mute-icon">üîá</div></div>
        <div class="seat" data-seat="6"><div class="username"></div><div class="status"></div><div class="mute-icon">üîá</div></div>
      </div>

      <div id="chat-container">
        <div id="chat-messages"></div>
        <div id="chat-input-container">
          <input type="text" id="chat-input" placeholder="Mesaj yaz..." autocomplete="off" />
          <button id="chat-send-btn" disabled>G√∂nder</button>
        </div>
      </div>

      <div id="gift-container" title="Koltuklara hediye g√∂nderin!">
        <div class="gift-box" data-gift="üéÅ" title="Hediye Kutusu">üéÅ</div>
        <div class="gift-box" data-gift="üåπ" title="G√ºl">üåπ</div>
        <div class="gift-box" data-gift="üç∞" title="Pasta">üç∞</div>
        <div class="gift-box" data-gift="üéâ" title="Konfeti">üéâ</div>
        <div class="gift-box" data-gift="üíé" title="Elmas">üíé</div>
      </div>

      <button id="mute-btn" disabled>üéôÔ∏è Mikrofon A√ß</button>

      <div id="status-bar">Hen√ºz bir koltuƒüa oturmadƒ±nƒ±z.</div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Parametre alma
    function getQueryParams() {
      const params = {};
      location.search.substring(1).split("&").forEach(pair => {
        const [key, value] = pair.split("=");
        if(key && value) {
          params[decodeURIComponent(key)] = decodeURIComponent(value.replace(/\+/g, " "));
        }
      });
      return params;
    }

    // Firebase config (kendi bilgilerinizi ekleyin)
    const firebaseConfig = {
      apiKey: "AIzaSyCTPTwYIuDBmROnBu30dzqoDYvb0pTcXuU",
      authDomain: "chat-9f75c.firebaseapp.com",
      databaseURL: "https://chat-9f75c-default-rtdb.firebaseio.com",
      projectId: "chat-9f75c",
      storageBucket: "chat-9f75c.appspot.com",
      messagingSenderId: "963858978848",
      appId: "1:963858978848:web:xxxxxxxxxxxxxx" // Burayƒ± kendi appId'nizle deƒüi≈ütirin
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let localStream = null;
    let peerConnections = {};
    let currentSeat = null;
    let username = "";
    let room = "";
    let muted = false;
    let seatsRef = null;

    const messageScreen = document.getElementById("message-screen");
    const roomScreen = document.getElementById("room-screen");
    const seatsContainer = document.getElementById("seats-container");
    const muteBtn = document.getElementById("mute-btn");
    const statusBar = document.getElementById("status-bar");
    const roomNameDisplay = document.getElementById("room-name-display");
    const usernameDisplay = document.getElementById("username-display");
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input");
    const chatSendBtn = document.getElementById("chat-send-btn");
    const giftContainer = document.getElementById("gift-container");

    const rtcConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };

    // Mesaj g√∂nderme, alma ve hediye fonksiyonlarƒ± burada olmalƒ± (√∂nceki koddaki t√ºm fonksiyonlarƒ± kopyalayƒ±n)

    // Kƒ±saca: 
    // - getQueryParams, showMessage, hideMessage fonksiyonlarƒ±
    // - listenSeats, sitOnSeat, leaveSeat, startPeerConnections, setupConnectionWithPeer, playRemoteAudio
    // - chat i√ßin sendMessage, listenChat, addChatMessage ve gift i√ßin sendGift, listenGifts, showGiftAnimation
    // - mute butonu ve diƒüer event listener‚Äôlar

    // √ñzet olarak t√ºm √∂nceki script bloƒüunu √ßalƒ±≈ütƒ±rabilirsiniz.

    window.addEventListener('load', async () => {
      const params = getQueryParams();
      room = params.oda ? params.oda.trim() : "";
      username = params.adim ? params.adim.trim() : "";

      if(!room || !username) {
        showMessage("URL parametrelerinde 'oda' ve 'adim' eksik veya bo≈ü.<br>Kullanƒ±m √∂rneƒüi:<br>?oda=ceka&adim=kullanƒ±cƒ±1");
        return;
      }

      try {
        localStream = await navigator.mediaDevices.getUserMedia({audio: true});
        localStream.getAudioTracks().forEach(t => t.enabled = false);

        hideMessage();
        roomScreen.style.display = "flex";

        roomNameDisplay.textContent = room;
        usernameDisplay.textContent = username;

        listenSeats();
        listenChat();
        listenGifts();

        statusBar.textContent = 'L√ºtfen bo≈ü bir koltuƒüa tƒ±klayƒ±n ve oturun.';
      } catch(err) {
        showMessage("Mikrofon kullanƒ±mƒ± reddedildi veya hata: " + err.message);
      }
    });

    // ƒ∞sterseniz √∂nceki uzun script bloƒüunu kopyalayƒ±p buraya ekleyebilirsiniz.

  </script>
</body>
</html>
