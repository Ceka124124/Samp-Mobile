<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>WebRTC Ã‡oklu Koltuk Sesli Sohbet</title>
  <style>
    /* Reset and base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #483D8B, #6A5ACD);
      color: #f0f0ff;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #app {
      max-width: 350px;
      margin: auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px 14px;
      gap: 10px;
    }
    h1 {
      text-align: center;
      margin: 10px 0;
      font-weight: 900;
      font-size: 1.8rem;
      color: #cbd5e1;
      text-shadow: 0 0 4px #94a3b8;
      user-select: none;
    }

    /* Message container */
    #message-screen {
      flex: 1;
      background: rgba(0,0,0,0.2);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      text-align: center;
      user-select: none;
    }

    /* Room screen */
    #room-screen {
      flex: 1;
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    /* Seats grid */
    #seats-container {
      flex-grow: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px;
      user-select: none;
    }
    .seat {
      background: rgba(255,255,255,0.15);
      border-radius: 14px;
      height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 12px;
      cursor: pointer;
      position: relative;
      box-shadow: 0 6px 10px rgba(0,0,0,0.25);
      transition: background-color 0.25s, box-shadow 0.3s;
      color: #e0e7ff;
    }
    .seat:hover {
      background: rgba(107, 70, 193, 0.8);
      box-shadow: 0 8px 22px #a78bfa;
    }
    .seat.occupied {
      cursor: default;
      background: #4338ca;
      box-shadow: 0 0 16px 2px #8b5cf6;
    }
    .seat .username {
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      overflow-wrap: break-word;
    }
    .seat .status {
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .seat .mute-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 22px;
      pointer-events: none;
      user-select: none;
      opacity: 0.8;
      color: #f87171; /* red for muted */
      display: none;
    }
    .seat.muted .mute-icon {
      display: block;
    }
    .seat.you {
      border: 3px solid #a78bfa;
    }

    /* Mute toggle button */
    #mute-btn {
      background: #a855f7;
      border: none;
      padding: 14px 0;
      color: white;
      font-weight: 700;
      font-size: 1.2rem;
      border-radius: 14px;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 5px 15px rgba(168,85,247,0.6);
      transition: background-color 0.3s ease;
    }
    #mute-btn.unmuted {
      background: #22c55e; /* green */
      box-shadow: 0 5px 15px rgba(34,197,94,0.7);
    }
    #mute-btn:disabled {
      background: #999;
      cursor: not-allowed;
      box-shadow: none;
    }
    #mute-btn:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    /* Status bar */
    #status-bar {
      font-weight: 600;
      font-size: 1rem;
      min-height: 1.4em;
      color: #c5c7f8;
      text-align: center;
      margin-top: 6px;
      user-select: none;
    }

    /* Scroll if needed but minimal */
    #seats-container {
      overflow-y: auto;
    }

    /* Sohbet alanÄ± */
    #chat-container {
      background: rgba(255 255 255 / 0.1);
      border-radius: 14px;
      padding: 10px;
      height: 150px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      user-select: none;
    }
    #chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      background: rgba(0 0 0 / 0.15);
      border-radius: 12px;
      padding: 8px;
      font-size: 0.9rem;
      color: #e0e7ff;
      scroll-behavior: smooth;
    }
    #chat-input-container {
      display: flex;
      gap: 6px;
    }
    #chat-input {
      flex-grow: 1;
      border-radius: 14px;
      border: none;
      padding: 8px 12px;
      font-size: 1rem;
      outline: none;
    }
    #chat-send-btn {
      background: #6b46c1;
      color: white;
      border: none;
      border-radius: 14px;
      padding: 8px 16px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    #chat-send-btn:hover:not(:disabled) {
      background: #553c9a;
    }
    #chat-send-btn:disabled {
      background: #999;
      cursor: not-allowed;
    }

    /* Hediye kutusu */
    #gift-container {
      display: flex;
      justify-content: center;
      margin-top: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .gift-box {
      background: rgba(255 255 255 / 0.15);
      border-radius: 12px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      user-select: none;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .gift-box:hover {
      background: rgba(107, 70, 193, 0.9);
      box-shadow: 0 6px 16px rgba(107,70,193,0.8);
    }

    @media (max-width: 400px) {
      #app {
        max-width: 100%;
        padding: 8px 10px;
      }
      .seat {
        height: 100px;
      }
      h1 {
        font-size: 1.5rem;
      }
      #mute-btn {
        font-size: 1rem;
        padding: 12px 0;
      }
      #chat-container {
        height: 130px;
      }
      .gift-box {
        width: 36px;
        height: 36px;
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>WebRTC Koltuk Sesli Sohbet</h1>

    <div id="message-screen" style="display:none;"></div>

    <div id="room-screen">
      <div>Oda: <span id="room-name-display"></span> | KullanÄ±cÄ±: <span id="username-display"></span></div>
      <div id="seats-container">
        <!-- 6 Koltuk -->
        <div class="seat" data-seat="1"><div class="username"></div><div class="status"></div><div class="mute-icon">ğŸ”‡</div></div>
        <div class="seat" data-seat="2"><div class="username"></div><div class="status"></div><div class="mute-icon">ğŸ”‡</div></div>
        <div class="seat" data-seat="3"><div class="username"></div><div class="status"></div><div class="mute-icon">ğŸ”‡</div></div>
        <div class="seat" data-seat="4"><div class="username"></div><div class="status"></div><div class="mute-icon">ğŸ”‡</div></div>
        <div class="seat" data-seat="5"><div class="username"></div><div class="status"></div><div class="mute-icon">ğŸ”‡</div></div>
        <div class="seat" data-seat="6"><div class="username"></div><div class="status"></div><div class="mute-icon">ğŸ”‡</div></div>
      </div>

      <!-- Sohbet AlanÄ± -->
      <div id="chat-container">
        <div id="chat-messages"></div>
        <div id="chat-input-container">
          <input type="text" id="chat-input" placeholder="Mesaj yaz..." autocomplete="off" />
          <button id="chat-send-btn" disabled>GÃ¶nder</button>
        </div>
      </div>

      <!-- Hediye Kutusu -->
      <div id="gift-container" title="Koltuklara hediye gÃ¶nderin!">
        <div class="gift-box" data-gift="ğŸ" title="Hediye Kutusu">ğŸ</div>
        <div class="gift-box" data-gift="ğŸŒ¹" title="GÃ¼l">ğŸŒ¹</div>
        <div class="gift-box" data-gift="ğŸ°" title="Pasta">ğŸ°</div>
        <div class="gift-box" data-gift="ğŸ‰" title="Konfeti">ğŸ‰</div>
        <div class="gift-box" data-gift="ğŸ’" title="Elmas">ğŸ’</div>
      </div>

      <button id="mute-btn" disabled>ğŸ™ï¸ Mikrofon AÃ§</button>

      <div id="status-bar">HenÃ¼z bir koltuÄŸa oturmadÄ±nÄ±z.</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // URL parametrelerini al
    function getQueryParams() {
      const params = {};
      location.search.substring(1).split("&").forEach(pair => {
        const [key, value] = pair.split("=");
        if(key && value) {
          params[decodeURIComponent(key)] = decodeURIComponent(value.replace(/\+/g, " "));
        }
      });
      return params;
    }

    // --- FÄ°REBASE KONFÄ°GURASYONU ---
    // BurayÄ± kendi Firebase projenizin konfigÃ¼rasyon bilgileri ile doldurun:
    const firebaseConfig = {
      apiKey: "AIzaSyCTPTwYIuDBmROnBu30dzqoDYvb0pTcXuU",
      authDomain: "chat-9f75c.firebaseapp.com",
      databaseURL: "https://chat-9f75c-default-rtdb.firebaseio.com",
      projectId: "chat-9f75c",
      storageBucket: "chat-9f75c.appspot.com",
      messagingSenderId: "963858978848",
      appId: "1:963858978848:web:xxxxxxxxxxxxxx"
    };

    // Firebase baÅŸlat
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- Global deÄŸiÅŸkenler ---
    let localStream = null;
    let peerConnections = {}; // her seat iÃ§in RTC baÄŸlantÄ±sÄ± (mesh)
    let currentSeat = null;
    let username = "";
    let room = "";
    let muted = false;
    let seatsRef = null;

    // HTML elementleri
    const messageScreen = document.getElementById("message-screen");
    const roomScreen = document.getElementById("room-screen");
    const seatsContainer = document.getElementById("seats-container");
    const muteBtn = document.getElementById("mute-btn");
    const statusBar = document.getElementById("status-bar");
    const roomNameDisplay = document.getElementById("room-name-display");
    const usernameDisplay = document.getElementById("username-display");
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input");
    const chatSendBtn = document.getElementById("chat-send-btn");
    const giftContainer = document.getElementById("gift-container");

    // RTC yapÄ±landÄ±rmasÄ±
    const rtcConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };

    // Mesaj gÃ¶nderme fonksiyonu
    function sendMessage(text) {
      if (!text.trim() || !currentSeat) return;
      const newMsgRef = database.ref(`rooms/${room}/chat`).push();
      newMsgRef.set({
        user: username,
        text: text.trim(),
        timestamp: Date.now()
      });
    }

    // Sohbet mesajlarÄ±nÄ± dinle
    function listenChat() {
      const chatRef = database.ref(`rooms/${room}/chat`);
      chatRef.off(); // Ã–nceki listener'Ä± temizle
      chatRef.limitToLast(50).on('child_added', snapshot => {
        const msg = snapshot.val();
        if(msg) {
          addChatMessage(msg.user, msg.text);
        }
      });
    }

    // MesajlarÄ± sohbet kutusuna ekle
    function addChatMessage(user, text) {
      const div = document.createElement('div');
      div.innerHTML = `<strong>${escapeHtml(user)}:</strong> ${escapeHtml(text)}`;
      chatMessages.appendChild(div);
      // Scroll en alta
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // HTML gÃ¼venliÄŸi iÃ§in basit kaÃ§Ä±rma fonksiyonu
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }

    // Hediye gÃ¶nderme fonksiyonu
    function sendGift(toSeat, gift) {
      if (!currentSeat || !gift) return;
      const giftsRef = database.ref(`rooms/${room}/gifts`);
      // Her hediye benzersiz id ile gÃ¶nderilebilir
      giftsRef.push({
        from: username,
        fromSeat: currentSeat,
        toSeat: toSeat,
        gift: gift,
        timestamp: Date.now()
      });
      alert(`Koltuk ${toSeat} numaralÄ± kullanÄ±cÄ±ya hediye gÃ¶nderdiniz: ${gift}`);
    }

    // Hediye mesajlarÄ±nÄ± dinle
    function listenGifts() {
      const giftsRef = database.ref(`rooms/${room}/gifts`);
      giftsRef.off();
      giftsRef.limitToLast(50).on('child_added', snapshot => {
        const gift = snapshot.val();
        if(gift && gift.toSeat && gift.from !== username) {
          const seatEl = findSeatElement(gift.toSeat);
          if(seatEl) {
            showGiftAnimation(seatEl, gift.gift, gift.from);
          }
        }
      });
    }

    // Hediye animasyonu gÃ¶sterimi
    function showGiftAnimation(seatEl, giftSymbol, fromUser) {
      const giftDiv = document.createElement('div');
      giftDiv.textContent = giftSymbol;
      giftDiv.style.position = 'absolute';
      giftDiv.style.bottom = '10px';
      giftDiv.style.right = '10px';
      giftDiv.style.fontSize = '26px';
      giftDiv.style.animation = 'giftAnim 2s ease forwards';
      giftDiv.title = `${fromUser} sana hediye gÃ¶nderdi!`;
      seatEl.appendChild(giftDiv);
      setTimeout(() => {
        seatEl.removeChild(giftDiv);
      }, 2000);
    }

    // Gift animasyonuna css ekleme
    const style = document.createElement('style');
    style.textContent = `
      @keyframes giftAnim {
        0% {opacity: 0; transform: translateY(20px);}
        50% {opacity: 1; transform: translateY(0);}
        100% {opacity: 0; transform: translateY(-20px);}
      }
    `;
    document.head.appendChild(style);

    // URL'den gelen bilgiler ile baÅŸlayalÄ±m
    window.addEventListener('load', async () => {
      const params = getQueryParams();
      room = params.oda ? params.oda.trim() : "";
      username = params.adim ? params.adim.trim() : "";

      if(!room || !username) {
        showMessage("URL parametrelerinde 'oda' ve 'adim' eksik veya boÅŸ.<br>KullanÄ±m Ã¶rneÄŸi:<br>?oda=ceka&adim=kullanÄ±cÄ±1");
        return;
      }

      try {
        // Mikrofona eriÅŸim iste
        localStream = await navigator.mediaDevices.getUserMedia({audio: true});
        // BaÅŸlangÄ±Ã§ta mic kapalÄ± (mute)
        localStream.getAudioTracks().forEach(t => t.enabled = false);

        hideMessage();
        roomScreen.style.display = "flex";

        roomNameDisplay.textContent = room;
        usernameDisplay.textContent = username;

        listenSeats();
        listenChat();
        listenGifts();

        statusBar.textContent = 'LÃ¼tfen boÅŸ bir koltuÄŸa tÄ±klayÄ±n ve oturun.';
      } catch(err) {
        showMessage("Mikrofon kullanÄ±mÄ± reddedildi veya hata: " + err.message);
      }
    });

    function showMessage(html) {
      messageScreen.innerHTML = html;
      messageScreen.style.display = "flex";
      roomScreen.style.display = "none";
    }
    function hideMessage() {
      messageScreen.style.display = "none";
    }

    // UI'da seat elemanÄ±nÄ± sayÄ±sal numara ile bul
    function findSeatElement(seatNum) {
      return seatsContainer.querySelector(`.seat[data-seat="${seatNum}"]`);
    }

    // Seat durumlarÄ±nÄ± Firebase'den dinle ve UI'Ä± gÃ¼ncelle
    function listenSeats() {
      seatsRef = database.ref(`rooms/${room}/seats`);
      seatsRef.on('value', snapshot => {
        const seatsData = snapshot.val() || {};
        for (let i = 1; i <= 6; i++) {
          const seatEl = findSeatElement(i);
          const seatData = seatsData[i];
          if (seatData && seatData.user) {
            seatEl.classList.add('occupied');
            seatEl.querySelector('.username').textContent = seatData.user;
            seatEl.querySelector('.status').textContent = seatData.muted ? 'Mikrofon kapalÄ±' : 'Mikrofon aÃ§Ä±k';
            seatEl.classList.toggle('muted', !!seatData.muted);
            if(currentSeat == i) {
              seatEl.classList.add('you');
              muteBtn.disabled = false;
              muteBtn.textContent = seatData.muted ? 'ğŸ™ï¸ Mikrofonu AÃ§' : 'ğŸ”‡ Mikrofonu Kapat';
              muteBtn.classList.toggle('unmuted', !seatData.muted);
              muted = seatData.muted;
            } else {
              seatEl.classList.remove('you');
            }
          } else {
            seatEl.classList.remove('occupied','muted','you');
            seatEl.querySelector('.username').textContent = '';
            seatEl.querySelector('.status').textContent = 'BoÅŸ koltuk';
          }
        }
      });
    }

    // Koltuk seÃ§me
    seatsContainer.addEventListener('click', async (ev) => {
      const seatEl = ev.target.closest('.seat');
      if (!seatEl) return;
      const seatNum = Number(seatEl.getAttribute('data-seat'));
      if (!seatNum) return;

      if (seatEl.classList.contains('occupied')) {
        if(currentSeat === seatNum) {
          // Koltuktan kalk
          if(confirm('Koltuktan kalkmak istediÄŸinize emin misiniz?')) {
            await leaveSeat();
          }
        } else {
          alert('Bu koltuk baÅŸka kullanÄ±cÄ± tarafÄ±ndan kullanÄ±lÄ±yor.');
        }
      } else {
        // Seat boÅŸ ise otur
        await sitOnSeat(seatNum);
      }
    });

    // Hediye kutusundaki tÄ±klamalar
    giftContainer.addEventListener('click', (ev) => {
      const giftBox = ev.target.closest('.gift-box');
      if (!giftBox) return;

      if (!currentSeat) {
        alert('Ã–nce bir koltuÄŸa oturmalÄ±sÄ±nÄ±z ki hediye gÃ¶nderebilesiniz!');
        return;
      }

      // Hediye gÃ¶nderilecek kullanÄ±cÄ± seÃ§imi iÃ§in basit prompt ile seÃ§im iste
      let toSeatStr = prompt('Hediye gÃ¶ndermek istediÄŸiniz koltuk numarasÄ±nÄ± girin (1-6):');
      if (!toSeatStr) return;
      const toSeatNum = parseInt(toSeatStr);
      if (isNaN(toSeatNum) || toSeatNum < 1 || toSeatNum > 6) {
        alert('GeÃ§ersiz koltuk numarasÄ±.');
        return;
      }
      if (toSeatNum === currentSeat) {
        alert('Kendinize hediye gÃ¶nderemezsiniz.');
        return;
      }

      const targetSeatEl = findSeatElement(toSeatNum);
      if (!targetSeatEl || !targetSeatEl.classList.contains('occupied')) {
        alert('SeÃ§ilen koltuk boÅŸ.');
        return;
      }

      const giftSymbol = giftBox.getAttribute('data-gift');
      sendGift(toSeatNum, giftSymbol);
    });

    async function sitOnSeat(seatNum) {
      if(currentSeat) {
        alert('Zaten bir koltuktasÄ±nÄ±z. Ã–nce kalkmalÄ±sÄ±nÄ±z.');
        return;
      }
      try {
        // Seat boÅŸ mu diye kontrol et
        const seatDataSnap = await database.ref(`rooms/${room}/seats/${seatNum}`).get();
        if(seatDataSnap.exists() && seatDataSnap.val().user) {
          alert('Bu koltuk ÅŸu an dolu.');
          return;
        }
        // Set current seat in DB
        await database.ref(`rooms/${room}/seats/${seatNum}`).set({
          user: username,
          muted: false
        });
        currentSeat = seatNum;

        // BaÅŸlangÄ±Ã§ta mute false, muteButon aktifleÅŸir
        muteBtn.disabled = false;

        // BaÅŸka kullanÄ±cÄ±lar iÃ§in signaling baÅŸlat
        await startPeerConnections();

        statusBar.textContent = `Koltuk ${seatNum}'de oturuyorsunuz. Mikrofon dÃ¼ÄŸmesini kullanarak sesinizi aÃ§Ä±p kapatabilirsiniz.`;
        chatSendBtn.disabled = false;
      } catch(e) {
        alert('Koltuk oturum hatasÄ±: ' + e.message);
      }
    }

    async function leaveSeat() {
      if(!currentSeat) return;
      try {
        // Firebase DB'den koltuÄŸu boÅŸalt
        await database.ref(`rooms/${room}/seats/${currentSeat}`).remove();

        // Singaling bilgilerini temizle (opsiyonel)
        await database.ref(`rooms/${room}/signals/${currentSeat}`).remove();

        // Peer baÄŸlantÄ±larÄ±nÄ± kapat
        for(const peerSeat in peerConnections) {
          peerConnections[peerSeat].close();
        }
        peerConnections = {};
        currentSeat = null;
        muteBtn.disabled = true;
        muted = false;
        chatSendBtn.disabled = true;
        statusBar.textContent = 'HenÃ¼z bir koltuÄŸa o
